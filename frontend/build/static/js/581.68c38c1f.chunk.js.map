{"version":3,"file":"static/js/581.68c38c1f.chunk.js","mappings":"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","sources":["services/socketService.ts","pages/messages/ConversationList.tsx","pages/messages/Conversation.tsx","pages/messages/Messages.tsx","pages/messages/NewConversation.tsx"],"sourcesContent":["import io, { Socket } from 'socket.io-client';\r\nimport { receiveMessage, markConversationAsRead, updateTotalUnreadCount } from '../redux/slices/messageSlice';\r\nimport { showAlert } from '../redux/slices/alertSlice';\r\nimport { AppDispatch } from '../redux/store';\r\n\r\nlet socket: typeof Socket | null = null;\r\n\r\nconst initSocket = (token: string, dispatch: AppDispatch) => {\r\n  // Close existing socket if it exists\r\n  if (socket) {\r\n    socket.close();\r\n  }\r\n\r\n  // Create new socket connection with auth token\r\n  const SOCKET_URL = process.env.NODE_ENV === 'production' ? '/' : 'http://localhost:5000';\r\n  socket = io(SOCKET_URL, {\r\n    auth: {\r\n      token\r\n    },\r\n    transports: ['websocket']\r\n  });\r\n\r\n  // Socket event listeners\r\n  socket.on('connect', () => {\r\n    console.log('Socket connected');\r\n  });\r\n\r\n  socket.on('disconnect', () => {\r\n    console.log('Socket disconnected');\r\n  });\r\n\r\n  socket.on('error', (error: any) => {\r\n    console.error('Socket error:', error);\r\n    dispatch(showAlert('error', 'Connection error. Please try again.'));\r\n  });\r\n\r\n  // Handle incoming messages\r\n  socket.on('message', (data: any) => {\r\n    dispatch(receiveMessage({\r\n      message: data.message,\r\n      conversationId: data.conversationId\r\n    }));\r\n  });\r\n\r\n  // Handle read receipts\r\n  socket.on('messageRead', (data: any) => {\r\n    dispatch(markConversationAsRead(data.conversationId));\r\n  });\r\n\r\n  // Handle unread count updates\r\n  socket.on('unreadCount', (data: any) => {\r\n    dispatch(updateTotalUnreadCount(data.count));\r\n  });\r\n\r\n  return socket;\r\n};\r\n\r\n// Join a conversation room\r\nconst joinConversation = (conversationId: string) => {\r\n  if (socket) {\r\n    socket.emit('joinConversation', { conversationId });\r\n  }\r\n};\r\n\r\n// Leave a conversation room\r\nconst leaveConversation = (conversationId: string) => {\r\n  if (socket) {\r\n    socket.emit('leaveConversation', { conversationId });\r\n  }\r\n};\r\n\r\n// Send a message\r\nconst emitMessage = (conversationId: string, message: any) => {\r\n  if (socket) {\r\n    socket.emit('sendMessage', { conversationId, message });\r\n  }\r\n};\r\n\r\n// Send typing indicator\r\nconst emitTyping = (conversationId: string, isTyping: boolean) => {\r\n  if (socket) {\r\n    socket.emit('typing', { conversationId, isTyping });\r\n  }\r\n};\r\n\r\n// Mark messages as read\r\nconst emitReadReceipt = (conversationId: string) => {\r\n  if (socket) {\r\n    socket.emit('markAsRead', { conversationId });\r\n  }\r\n};\r\n\r\n// Close socket connection\r\nexport const closeSocket = () => {\r\n  if (socket) {\r\n    socket.close();\r\n    socket = null;\r\n  }\r\n};\r\n\r\n// Export socketService object\r\nexport const socketService = {\r\n  init: (dispatch: AppDispatch) => {\r\n    const token = localStorage.getItem('token');\r\n    if (token) {\r\n      return initSocket(token, dispatch);\r\n    }\r\n    return null;\r\n  },\r\n  disconnect: closeSocket,\r\n  joinConversation,\r\n  leaveConversation,\r\n  sendMessage: emitMessage,\r\n  typing: emitTyping, // This is what we use for typing status\r\n  markMessagesAsRead: emitReadReceipt\r\n};","import React, { useEffect, useState } from \"react\";\r\nimport { useSelector } from \"react-redux\";\r\nimport { useNavigate, useLocation } from \"react-router-dom\";\r\nimport {\r\n  getConversations,\r\n  archiveConversation,\r\n} from \"../../redux/slices/messageSlice\";\r\nimport { socketService } from \"../../services/socketService\";\r\nimport NewConversation from \"./NewConversation\";\r\nimport { RootState, useAppDispatch } from \"../../redux/store\";\r\n\r\n// MUI components\r\nimport Box from \"@mui/material/Box\";\r\nimport Typography from \"@mui/material/Typography\";\r\nimport List from \"@mui/material/List\";\r\nimport ListItem from \"@mui/material/ListItem\";\r\nimport ListItemAvatar from \"@mui/material/ListItemAvatar\";\r\nimport ListItemText from \"@mui/material/ListItemText\";\r\nimport ListItemSecondaryAction from \"@mui/material/ListItemSecondaryAction\";\r\nimport Avatar from \"@mui/material/Avatar\";\r\nimport Divider from \"@mui/material/Divider\";\r\nimport Badge from \"@mui/material/Badge\";\r\nimport IconButton from \"@mui/material/IconButton\";\r\nimport Menu from \"@mui/material/Menu\";\r\nimport MenuItem from \"@mui/material/MenuItem\";\r\nimport Paper from \"@mui/material/Paper\";\r\nimport InputBase from \"@mui/material/InputBase\";\r\nimport Skeleton from \"@mui/material/Skeleton\";\r\nimport Chip from \"@mui/material/Chip\";\r\nimport Button from \"@mui/material/Button\";\r\n\r\n// MUI icons\r\nimport SearchIcon from \"@mui/icons-material/Search\";\r\nimport MoreVertIcon from \"@mui/icons-material/MoreVert\";\r\nimport ArchiveIcon from \"@mui/icons-material/Archive\";\r\nimport DeleteIcon from \"@mui/icons-material/Delete\";\r\nimport HomeIcon from \"@mui/icons-material/Home\";\r\nimport AddIcon from \"@mui/icons-material/Add\";\r\n\r\n// Types\r\ninterface User {\r\n  _id: string;\r\n  name: string;\r\n  avatar?: string;\r\n  userType?: string;\r\n}\r\n\r\ninterface Property {\r\n  _id: string;\r\n  title: string;\r\n}\r\n\r\ninterface Message {\r\n  _id: string;\r\n  content?: string;\r\n  attachments?: any[];\r\n  createdAt: string;\r\n}\r\n\r\ninterface Conversation {\r\n  _id: string;\r\n  participants: User[];\r\n  lastMessage?: Message;\r\n  unreadCount: number;\r\n  property?: Property;\r\n}\r\n\r\ninterface AuthState {\r\n  user: User | null;\r\n}\r\n\r\nconst ConversationList = () => {\r\n  const dispatch = useAppDispatch();\r\n  const navigate = useNavigate();\r\n  const location = useLocation();\r\n\r\n  const { user } = useSelector((state: RootState) => state.auth as AuthState);\r\n  const { conversations, loading } = useSelector(\r\n    (state: RootState) => state.message as any\r\n  );\r\n\r\n  const [searchTerm, setSearchTerm] = useState<string>(\"\");\r\n  const [menuAnchorEl, setMenuAnchorEl] = useState<HTMLElement | null>(null);\r\n  const [selectedConversation, setSelectedConversation] =\r\n    useState<Conversation | null>(null);\r\n  const [newConversationOpen, setNewConversationOpen] =\r\n    useState<boolean>(false);\r\n\r\n  // Fetch conversations on component mount\r\n  useEffect(() => {\r\n    dispatch(getConversations());\r\n  }, [dispatch]);\r\n\r\n  // Handle menu open\r\n  const handleMenuOpen = (\r\n    event: React.MouseEvent<HTMLElement>,\r\n    conversation: Conversation\r\n  ) => {\r\n    event.stopPropagation();\r\n    setMenuAnchorEl(event.currentTarget);\r\n    setSelectedConversation(conversation);\r\n  };\r\n\r\n  // Handle menu close\r\n  const handleMenuClose = () => {\r\n    setMenuAnchorEl(null);\r\n    setSelectedConversation(null);\r\n  };\r\n\r\n  // Handle archive conversation\r\n  const handleArchiveConversation = () => {\r\n    if (selectedConversation) {\r\n      dispatch(archiveConversation(selectedConversation._id));\r\n      handleMenuClose();\r\n    }\r\n  };\r\n\r\n  // Navigate to conversation\r\n  const handleConversationClick = (conversationId: string) => {\r\n    navigate(`/messages/${conversationId}`);\r\n\r\n    // Mark messages as read via socket\r\n    socketService.markMessagesAsRead(conversationId);\r\n  };\r\n\r\n  // Format last message time\r\n  const formatLastMessageTime = (timestamp?: string) => {\r\n    if (!timestamp) return \"\";\r\n    const date = new Date(timestamp);\r\n    const now = new Date();\r\n    const diffMs = now.getTime() - date.getTime();\r\n    const diffMins = Math.floor(diffMs / 60000);\r\n    const diffHours = Math.floor(diffMins / 60);\r\n    const diffDays = Math.floor(diffHours / 24);\r\n\r\n    if (diffMins < 1) return \"Just now\";\r\n    if (diffMins < 60) return `${diffMins}m ago`;\r\n    if (diffHours < 24) return `${diffHours}h ago`;\r\n    if (diffDays < 7) return `${diffDays}d ago`;\r\n\r\n    return date.toLocaleDateString([], { month: \"short\", day: \"numeric\" });\r\n  };\r\n\r\n  // Get other participant (not the current user)\r\n  const getOtherParticipant = (conversation: Conversation) => {\r\n    return conversation.participants.find(\r\n      (participant) => participant._id !== user?._id\r\n    );\r\n  };\r\n\r\n  // Filter conversations based on search term\r\n  const filteredConversations = conversations.filter(\r\n    (conversation: Conversation) => {\r\n      const otherParticipant = getOtherParticipant(conversation);\r\n      if (!otherParticipant || !otherParticipant.name) return false;\r\n\r\n      return otherParticipant.name\r\n        .toLowerCase()\r\n        .includes(searchTerm.toLowerCase());\r\n    }\r\n  );\r\n\r\n  // Render conversation item\r\n  const renderConversationItem = (conversation: Conversation) => {\r\n    const otherParticipant = getOtherParticipant(conversation);\r\n    if (!otherParticipant) return null;\r\n\r\n    const isActive = location.pathname === `/messages/${conversation._id}`;\r\n    const lastMessage = conversation.lastMessage;\r\n\r\n    return (\r\n      <React.Fragment key={conversation._id}>\r\n        <ListItem\r\n          button\r\n          alignItems=\"flex-start\"\r\n          onClick={() => handleConversationClick(conversation._id)}\r\n          sx={{\r\n            bgcolor: isActive ? \"action.selected\" : \"inherit\",\r\n            \"&:hover\": {\r\n              bgcolor: isActive ? \"action.selected\" : \"action.hover\",\r\n            },\r\n            py: 1.5,\r\n          }}\r\n        >\r\n          <ListItemAvatar>\r\n            <Badge\r\n              color=\"primary\"\r\n              badgeContent={conversation.unreadCount}\r\n              invisible={conversation.unreadCount === 0}\r\n              overlap=\"circular\"\r\n            >\r\n              <Avatar\r\n                alt={otherParticipant.name}\r\n                src={otherParticipant.avatar}\r\n              />\r\n            </Badge>\r\n          </ListItemAvatar>\r\n\r\n          <ListItemText\r\n            primary={\r\n              <Box\r\n                sx={{\r\n                  display: \"flex\",\r\n                  justifyContent: \"space-between\",\r\n                  alignItems: \"center\",\r\n                }}\r\n              >\r\n                <Typography\r\n                  variant=\"subtitle1\"\r\n                  sx={{\r\n                    fontWeight:\r\n                      conversation.unreadCount > 0 ? \"bold\" : \"normal\",\r\n                    color:\r\n                      conversation.unreadCount > 0 ? \"text.primary\" : \"inherit\",\r\n                  }}\r\n                >\r\n                  {otherParticipant.name}\r\n                </Typography>\r\n                <Typography variant=\"caption\" color=\"text.secondary\">\r\n                  {formatLastMessageTime(lastMessage?.createdAt)}\r\n                </Typography>\r\n              </Box>\r\n            }\r\n            secondary={\r\n              <Box>\r\n                <Typography\r\n                  variant=\"body2\"\r\n                  color=\"text.secondary\"\r\n                  sx={{\r\n                    display: \"inline\",\r\n                    fontWeight:\r\n                      conversation.unreadCount > 0 ? \"medium\" : \"normal\",\r\n                    color:\r\n                      conversation.unreadCount > 0 ? \"text.primary\" : \"inherit\",\r\n                  }}\r\n                  noWrap\r\n                >\r\n                  {lastMessage ? (\r\n                    lastMessage.attachments &&\r\n                    lastMessage.attachments.length > 0 ? (\r\n                      <Box\r\n                        component=\"span\"\r\n                        sx={{ display: \"flex\", alignItems: \"center\" }}\r\n                      >\r\n                        {lastMessage.content\r\n                          ? lastMessage.content\r\n                          : \"Sent an attachment\"}\r\n                      </Box>\r\n                    ) : (\r\n                      lastMessage?.content\r\n                    )\r\n                  ) : (\r\n                    \"No messages yet\"\r\n                  )}\r\n                </Typography>\r\n\r\n                {conversation.property && (\r\n                  <Chip\r\n                    icon={<HomeIcon fontSize=\"small\" />}\r\n                    label={\r\n                      conversation.property.title.substring(0, 15) +\r\n                      (conversation.property.title.length > 15 ? \"...\" : \"\")\r\n                    }\r\n                    size=\"small\"\r\n                    sx={{ mt: 0.5, maxWidth: \"100%\" }}\r\n                  />\r\n                )}\r\n              </Box>\r\n            }\r\n          />\r\n\r\n          <ListItemSecondaryAction>\r\n            <IconButton\r\n              edge=\"end\"\r\n              onClick={(e) => handleMenuOpen(e, conversation)}\r\n              size=\"small\"\r\n            >\r\n              <MoreVertIcon />\r\n            </IconButton>\r\n          </ListItemSecondaryAction>\r\n        </ListItem>\r\n        <Divider component=\"li\" />\r\n      </React.Fragment>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <Box sx={{ height: \"100%\", display: \"flex\", flexDirection: \"column\" }}>\r\n      {/* Search bar and new conversation button */}\r\n      <Box sx={{ display: \"flex\", mb: 2, gap: 1 }}>\r\n        <Paper\r\n          component=\"form\"\r\n          sx={{\r\n            p: \"2px 4px\",\r\n            display: \"flex\",\r\n            alignItems: \"center\",\r\n            boxShadow: 1,\r\n            flexGrow: 1,\r\n          }}\r\n        >\r\n          <IconButton sx={{ p: \"10px\" }} aria-label=\"search\">\r\n            <SearchIcon />\r\n          </IconButton>\r\n          <InputBase\r\n            sx={{ ml: 1, flex: 1 }}\r\n            placeholder=\"Search conversations\"\r\n            value={searchTerm}\r\n            onChange={(e) => setSearchTerm(e.target.value)}\r\n          />\r\n        </Paper>\r\n\r\n        <Button\r\n          variant=\"contained\"\r\n          color=\"primary\"\r\n          startIcon={<AddIcon />}\r\n          onClick={() => setNewConversationOpen(true)}\r\n        >\r\n          New\r\n        </Button>\r\n      </Box>\r\n\r\n      {/* Conversations list */}\r\n      <Paper\r\n        elevation={2}\r\n        sx={{\r\n          flexGrow: 1,\r\n          overflow: \"auto\",\r\n          maxHeight: \"calc(100vh - 240px)\",\r\n        }}\r\n      >\r\n        {loading ? (\r\n          // Loading skeletons\r\n          <List>\r\n            {[...Array(5)].map((_, index) => (\r\n              <React.Fragment key={index}>\r\n                <ListItem alignItems=\"flex-start\">\r\n                  <ListItemAvatar>\r\n                    <Skeleton variant=\"circular\" width={40} height={40} />\r\n                  </ListItemAvatar>\r\n                  <ListItemText\r\n                    primary={<Skeleton width=\"70%\" />}\r\n                    secondary={\r\n                      <React.Fragment>\r\n                        <Skeleton width=\"90%\" />\r\n                        <Skeleton width=\"40%\" />\r\n                      </React.Fragment>\r\n                    }\r\n                  />\r\n                </ListItem>\r\n                <Divider component=\"li\" />\r\n              </React.Fragment>\r\n            ))}\r\n          </List>\r\n        ) : filteredConversations.length === 0 ? (\r\n          // No conversations\r\n          <Box\r\n            sx={{\r\n              display: \"flex\",\r\n              justifyContent: \"center\",\r\n              alignItems: \"center\",\r\n              height: \"100%\",\r\n              p: 3,\r\n            }}\r\n          >\r\n            <Typography variant=\"body1\" color=\"text.secondary\" align=\"center\">\r\n              {searchTerm\r\n                ? \"No conversations match your search\"\r\n                : \"No conversations yet\"}\r\n            </Typography>\r\n          </Box>\r\n        ) : (\r\n          // Conversations list\r\n          <List sx={{ width: \"100%\", bgcolor: \"background.paper\", p: 0 }}>\r\n            {filteredConversations.map((conversation: Conversation) =>\r\n              renderConversationItem(conversation)\r\n            )}\r\n          </List>\r\n        )}\r\n      </Paper>\r\n\r\n      {/* Conversation actions menu */}\r\n      <Menu\r\n        anchorEl={menuAnchorEl}\r\n        open={Boolean(menuAnchorEl)}\r\n        onClose={handleMenuClose}\r\n      >\r\n        <MenuItem onClick={handleArchiveConversation}>\r\n          <ArchiveIcon fontSize=\"small\" sx={{ mr: 1 }} />\r\n          Archive\r\n        </MenuItem>\r\n        <MenuItem onClick={handleMenuClose}>\r\n          <DeleteIcon fontSize=\"small\" sx={{ mr: 1 }} />\r\n          Delete\r\n        </MenuItem>\r\n      </Menu>\r\n\r\n      {/* New Conversation Dialog */}\r\n      <NewConversation\r\n        open={newConversationOpen}\r\n        onClose={() => setNewConversationOpen(false)}\r\n      />\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default ConversationList;\r\n","import React, { useState, useEffect, useRef } from \"react\";\r\nimport { useParams, useNavigate } from \"react-router-dom\";\r\nimport { useDispatch, useSelector } from \"react-redux\";\r\nimport { getMessages, sendMessage } from \"../../redux/slices/messageSlice\";\r\nimport { socketService } from \"../../services/socketService\";\r\nimport { RootState } from \"../../redux/store\";\r\nimport { AppDispatch } from \"../../redux/store\";\r\n\r\n// MUI components\r\nimport Box from \"@mui/material/Box\";\r\nimport Typography from \"@mui/material/Typography\";\r\nimport Paper from \"@mui/material/Paper\";\r\nimport Divider from \"@mui/material/Divider\";\r\nimport TextField from \"@mui/material/TextField\";\r\nimport Button from \"@mui/material/Button\";\r\nimport IconButton from \"@mui/material/IconButton\";\r\nimport Avatar from \"@mui/material/Avatar\";\r\nimport CircularProgress from \"@mui/material/CircularProgress\";\r\nimport Card from \"@mui/material/Card\";\r\nimport CardMedia from \"@mui/material/CardMedia\";\r\nimport CardContent from \"@mui/material/CardContent\";\r\n// removed unused: Tooltip\r\n\r\n// MUI icons\r\nimport SendIcon from \"@mui/icons-material/Send\";\r\nimport AttachFileIcon from \"@mui/icons-material/AttachFile\";\r\n// removed unused: ImageIcon\r\nimport InsertDriveFileIcon from \"@mui/icons-material/InsertDriveFile\";\r\nimport ArrowBackIcon from \"@mui/icons-material/ArrowBack\";\r\n\r\n// Types\r\ninterface User {\r\n  _id: string;\r\n  name: string;\r\n  avatar?: string;\r\n  userType?: string;\r\n}\r\n\r\ninterface Property {\r\n  _id: string;\r\n  title: string;\r\n  address: {\r\n    city: string;\r\n    state: string;\r\n  };\r\n  price: {\r\n    amount: number;\r\n    brokerage?: number;\r\n  };\r\n  images?: string[];\r\n}\r\n\r\ninterface Attachment {\r\n  _id: string;\r\n  url: string;\r\n  filename: string;\r\n  mimetype: string;\r\n}\r\n\r\ninterface Message {\r\n  _id: string;\r\n  content?: string;\r\n  sender: string | User | any; // Accept string (user ID), User object, or ObjectId object\r\n  attachments?: Attachment[];\r\n  createdAt: string;\r\n  read?: boolean;\r\n}\r\n\r\ninterface ConversationData {\r\n  _id: string;\r\n  participants: User[];\r\n  property?: Property;\r\n}\r\n\r\ninterface ConversationState {\r\n  currentConversation: ConversationData | null;\r\n  messages: Message[];\r\n  loading: boolean;\r\n}\r\n\r\ninterface AuthState {\r\n  user: User | null;\r\n}\r\n\r\nconst Conversation = () => {\r\n  const { id } = useParams<{ id: string }>();\r\n  const navigate = useNavigate();\r\n  const dispatch = useDispatch<AppDispatch>();\r\n\r\n  const { user } = useSelector((state: RootState) => state.auth as AuthState);\r\n  const { currentConversation, messages, loading } = useSelector(\r\n    (state: RootState) => state.message as ConversationState\r\n  );\r\n\r\n  const [messageText, setMessageText] = useState<string>(\"\");\r\n  const [attachments, setAttachments] = useState<File[]>([]);\r\n  const [isTyping, setIsTyping] = useState<boolean>(false);\r\n  const [typingTimeout, setTypingTimeout] = useState<NodeJS.Timeout | null>(\r\n    null\r\n  );\r\n  const [isSending, setIsSending] = useState<boolean>(false);\r\n\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // Get other participant (not the current user)\r\n  const otherParticipant = currentConversation?.participants?.find(\r\n    (participant) => participant._id !== user?._id\r\n  );\r\n\r\n  // Fetch messages when conversation ID changes\r\n  useEffect(() => {\r\n    if (id) {\r\n      dispatch(getMessages(id));\r\n\r\n      // Join the conversation room via socket\r\n      socketService.joinConversation(id);\r\n\r\n      // Mark messages as read\r\n      socketService.markMessagesAsRead(id);\r\n\r\n      // Clean up when leaving the conversation\r\n      return () => {\r\n        socketService.leaveConversation(id);\r\n      };\r\n    }\r\n  }, [dispatch, id]);\r\n\r\n  // Scroll to bottom when messages change\r\n  useEffect(() => {\r\n    scrollToBottom();\r\n  }, [messages]);\r\n\r\n  // Handle typing indicator\r\n  useEffect(() => {\r\n    if (messageText && !isTyping) {\r\n      setIsTyping(true);\r\n      socketService.typing(id!, true);\r\n    }\r\n\r\n    // Clear previous timeout\r\n    if (typingTimeout) {\r\n      clearTimeout(typingTimeout);\r\n    }\r\n\r\n    // Set new timeout\r\n    const timeout = setTimeout(() => {\r\n      if (isTyping) {\r\n        setIsTyping(false);\r\n        socketService.typing(id!, false);\r\n      }\r\n    }, 2000);\r\n\r\n    setTypingTimeout(timeout);\r\n\r\n    // Clean up\r\n    return () => {\r\n      if (typingTimeout) {\r\n        clearTimeout(typingTimeout);\r\n      }\r\n    };\r\n  }, [messageText, isTyping, id, typingTimeout]);\r\n\r\n  // Scroll to bottom of messages\r\n  const scrollToBottom = () => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n  };\r\n\r\n  // Handle file input change\r\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const files = Array.from(e.target.files || []);\r\n    if (files.length === 0) return;\r\n\r\n    // Validate file types and sizes\r\n    const validFiles = files.filter((file) => {\r\n      const isValidSize = file.size <= 5 * 1024 * 1024; // 5MB max\r\n      if (!isValidSize) {\r\n        alert(\"File size should not exceed 5MB\");\r\n      }\r\n      return isValidSize;\r\n    });\r\n\r\n    if (validFiles.length === 0) return;\r\n\r\n    // Add to attachments\r\n    setAttachments([...attachments, ...validFiles]);\r\n\r\n    // Reset file input\r\n    e.target.value = \"\";\r\n  };\r\n\r\n  // Remove attachment\r\n  const handleRemoveAttachment = (index: number) => {\r\n    setAttachments(attachments.filter((_, i) => i !== index));\r\n  };\r\n\r\n  // Handle message submission\r\n  const handleSendMessage = async () => {\r\n    if ((!messageText.trim() && attachments.length === 0) || isSending) return;\r\n\r\n    setIsSending(true);\r\n\r\n    try {\r\n      await dispatch(\r\n        sendMessage({\r\n          conversationId: id!,\r\n          content: messageText.trim(),\r\n          attachments: attachments,\r\n        })\r\n      );\r\n\r\n      // Clear form\r\n      setMessageText(\"\");\r\n      setAttachments([]);\r\n    } catch (error) {\r\n      console.error(\"Error sending message:\", error);\r\n    } finally {\r\n      setIsSending(false);\r\n    }\r\n  };\r\n\r\n  // Format timestamp\r\n  const formatMessageTime = (timestamp: string) => {\r\n    const date = new Date(timestamp);\r\n    const today = new Date();\r\n    const yesterday = new Date(today);\r\n    yesterday.setDate(yesterday.getDate() - 1);\r\n\r\n    // Check if same day\r\n    if (date.toDateString() === today.toDateString()) {\r\n      return date.toLocaleTimeString([], {\r\n        hour: \"2-digit\",\r\n        minute: \"2-digit\",\r\n      });\r\n    }\r\n\r\n    // Check if yesterday\r\n    if (date.toDateString() === yesterday.toDateString()) {\r\n      return `Yesterday, ${date.toLocaleTimeString([], {\r\n        hour: \"2-digit\",\r\n        minute: \"2-digit\",\r\n      })}`;\r\n    }\r\n\r\n    // Otherwise show date and time\r\n    return (\r\n      date.toLocaleDateString([], { month: \"short\", day: \"numeric\" }) +\r\n      \", \" +\r\n      date.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" })\r\n    );\r\n  };\r\n\r\n  // Group messages by date\r\n  const groupMessagesByDate = () => {\r\n    const groups: Record<string, Message[]> = {};\r\n\r\n    messages.forEach((message) => {\r\n      const date = new Date(message.createdAt).toDateString();\r\n      if (!groups[date]) {\r\n        groups[date] = [];\r\n      }\r\n      groups[date].push(message);\r\n    });\r\n\r\n    return groups;\r\n  };\r\n\r\n  // Format date header\r\n  const formatDateHeader = (dateString: string) => {\r\n    const date = new Date(dateString);\r\n    const today = new Date();\r\n    const yesterday = new Date(today);\r\n    yesterday.setDate(yesterday.getDate() - 1);\r\n\r\n    if (date.toDateString() === today.toDateString()) {\r\n      return \"Today\";\r\n    }\r\n\r\n    if (date.toDateString() === yesterday.toDateString()) {\r\n      return \"Yesterday\";\r\n    }\r\n\r\n    return date.toLocaleDateString([], {\r\n      weekday: \"long\",\r\n      month: \"long\",\r\n      day: \"numeric\",\r\n    });\r\n  };\r\n\r\n  // Render attachment preview\r\n  const renderAttachmentPreview = (file: File, index: number) => {\r\n    const isImage = file.type.startsWith(\"image/\");\r\n\r\n    return (\r\n      <Box\r\n        key={index}\r\n        sx={{\r\n          position: \"relative\",\r\n          display: \"inline-block\",\r\n          m: 0.5,\r\n          borderRadius: 1,\r\n          overflow: \"hidden\",\r\n          border: \"1px solid\",\r\n          borderColor: \"divider\",\r\n        }}\r\n      >\r\n        {isImage ? (\r\n          <Box\r\n            component=\"img\"\r\n            src={URL.createObjectURL(file)}\r\n            alt=\"Attachment preview\"\r\n            sx={{ width: 80, height: 80, objectFit: \"cover\" }}\r\n          />\r\n        ) : (\r\n          <Box\r\n            sx={{\r\n              width: 80,\r\n              height: 80,\r\n              display: \"flex\",\r\n              alignItems: \"center\",\r\n              justifyContent: \"center\",\r\n              bgcolor: \"action.hover\",\r\n            }}\r\n          >\r\n            <InsertDriveFileIcon />\r\n          </Box>\r\n        )}\r\n        <IconButton\r\n          size=\"small\"\r\n          sx={{\r\n            position: \"absolute\",\r\n            top: 0,\r\n            right: 0,\r\n            bgcolor: \"rgba(0,0,0,0.5)\",\r\n            color: \"white\",\r\n            \"&:hover\": { bgcolor: \"rgba(0,0,0,0.7)\" },\r\n            p: 0.2,\r\n          }}\r\n          onClick={() => handleRemoveAttachment(index)}\r\n        >\r\n          Ã—\r\n        </IconButton>\r\n        <Typography\r\n          variant=\"caption\"\r\n          sx={{\r\n            position: \"absolute\",\r\n            bottom: 0,\r\n            left: 0,\r\n            right: 0,\r\n            bgcolor: \"rgba(0,0,0,0.5)\",\r\n            color: \"white\",\r\n            textOverflow: \"ellipsis\",\r\n            overflow: \"hidden\",\r\n            whiteSpace: \"nowrap\",\r\n            px: 1,\r\n          }}\r\n        >\r\n          {file.name.length > 10\r\n            ? `${file.name.substring(0, 7)}...`\r\n            : file.name}\r\n        </Typography>\r\n      </Box>\r\n    );\r\n  };\r\n\r\n  // Render message attachment\r\n  const renderMessageAttachment = (attachment: Attachment) => {\r\n    const isImage = attachment.mimetype.startsWith(\"image/\");\r\n\r\n    if (isImage) {\r\n      return (\r\n        <Box\r\n          key={String(attachment._id)}\r\n          component=\"img\"\r\n          src={attachment.url}\r\n          alt=\"Attachment\"\r\n          sx={{\r\n            maxWidth: \"100%\",\r\n            maxHeight: 200,\r\n            borderRadius: 1,\r\n            mb: 1,\r\n          }}\r\n        />\r\n      );\r\n    }\r\n\r\n    return (\r\n      <Box\r\n        key={String(attachment._id)}\r\n        component=\"a\"\r\n        href={attachment.url}\r\n        target=\"_blank\"\r\n        rel=\"noopener noreferrer\"\r\n        sx={{\r\n          display: \"flex\",\r\n          alignItems: \"center\",\r\n          p: 1,\r\n          mb: 1,\r\n          borderRadius: 1,\r\n          bgcolor: \"action.hover\",\r\n          textDecoration: \"none\",\r\n          color: \"text.primary\",\r\n        }}\r\n      >\r\n        <InsertDriveFileIcon sx={{ mr: 1 }} />\r\n        <Typography variant=\"body2\" noWrap>\r\n          {attachment.filename}\r\n        </Typography>\r\n      </Box>\r\n    );\r\n  };\r\n\r\n  // Render property card if conversation has a property\r\n  const renderPropertyCard = () => {\r\n    if (!currentConversation?.property) return null;\r\n\r\n    const property = currentConversation.property;\r\n\r\n    return (\r\n      <Card sx={{ mb: 2 }}>\r\n        <CardMedia\r\n          component=\"img\"\r\n          height=\"140\"\r\n          image={\r\n            property.images && property.images.length > 0\r\n              ? property.images[0]\r\n              : \"https://picsum.photos/seed/no-image-convo/300/140\"\r\n          }\r\n          alt={property.title}\r\n        />\r\n        <CardContent>\r\n          <Typography variant=\"h6\" component=\"div\" noWrap>\r\n            {property.title}\r\n          </Typography>\r\n          <Typography variant=\"body2\" color=\"text.secondary\">\r\n            {property.address.city}, {property.address.state}\r\n          </Typography>\r\n          <Typography variant=\"body1\" sx={{ mt: 1 }}>\r\n            ${property.price.amount}\r\n            {property.price.brokerage && property.price.brokerage > 0 ? (\r\n              <span> (Brokerage: {property.price.brokerage})</span>\r\n            ) : null}\r\n          </Typography>\r\n          <Button\r\n            size=\"small\"\r\n            sx={{ mt: 1 }}\r\n            onClick={() => navigate(`/properties/${property._id}`)}\r\n          >\r\n            View Property\r\n          </Button>\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  };\r\n\r\n  if (loading && !currentConversation) {\r\n    return (\r\n      <Box\r\n        sx={{\r\n          display: \"flex\",\r\n          justifyContent: \"center\",\r\n          alignItems: \"center\",\r\n          height: \"50vh\",\r\n        }}\r\n      >\r\n        <CircularProgress />\r\n      </Box>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Box\r\n      sx={{\r\n        height: \"calc(100vh - 180px)\",\r\n        display: \"flex\",\r\n        flexDirection: \"column\",\r\n      }}\r\n    >\r\n      {/* Conversation Header */}\r\n      <Paper elevation={2} sx={{ p: 2, mb: 2 }}>\r\n        <Box sx={{ display: \"flex\", alignItems: \"center\" }}>\r\n          <IconButton sx={{ mr: 1 }} onClick={() => navigate(\"/messages\")}>\r\n            <ArrowBackIcon />\r\n          </IconButton>\r\n          {otherParticipant && (\r\n            <>\r\n              <Avatar\r\n                src={otherParticipant.avatar}\r\n                alt={otherParticipant.name}\r\n                sx={{ mr: 2 }}\r\n              />\r\n              <Box>\r\n                <Typography variant=\"h6\">{otherParticipant.name}</Typography>\r\n                <Typography variant=\"body2\" color=\"text.secondary\">\r\n                  {otherParticipant?.userType\r\n                    ? otherParticipant.userType\r\n                        .split(\"_\")\r\n                        .map(\r\n                          (word) => word.charAt(0).toUpperCase() + word.slice(1)\r\n                        )\r\n                        .join(\" \")\r\n                    : \"User\"}\r\n                </Typography>\r\n              </Box>\r\n            </>\r\n          )}\r\n        </Box>\r\n      </Paper>\r\n\r\n      {/* Property Card (if applicable) */}\r\n      {renderPropertyCard()}\r\n\r\n      {/* Messages Container */}\r\n      <Paper\r\n        elevation={2}\r\n        sx={{\r\n          p: 2,\r\n          mb: 2,\r\n          flexGrow: 1,\r\n          overflow: \"auto\",\r\n          display: \"flex\",\r\n          flexDirection: \"column\",\r\n        }}\r\n      >\r\n        {loading ? (\r\n          <Box\r\n            sx={{\r\n              display: \"flex\",\r\n              justifyContent: \"center\",\r\n              alignItems: \"center\",\r\n              height: \"100%\",\r\n            }}\r\n          >\r\n            <CircularProgress />\r\n          </Box>\r\n        ) : messages.length === 0 ? (\r\n          <Box\r\n            sx={{\r\n              display: \"flex\",\r\n              justifyContent: \"center\",\r\n              alignItems: \"center\",\r\n              height: \"100%\",\r\n            }}\r\n          >\r\n            <Typography variant=\"body1\" color=\"text.secondary\">\r\n              No messages yet. Start the conversation!\r\n            </Typography>\r\n          </Box>\r\n        ) : (\r\n          <>\r\n            {Object.entries(groupMessagesByDate()).map(\r\n              ([date, dateMessages]) => (\r\n                <Box key={date}>\r\n                  <Divider sx={{ my: 2 }}>\r\n                    <Typography variant=\"caption\" color=\"text.secondary\">\r\n                      {formatDateHeader(date)}\r\n                    </Typography>\r\n                  </Divider>\r\n\r\n                  {dateMessages.map((message) => {\r\n                    // Handle sender which can be: string ID, ObjectId object, or User object\r\n                    let senderId: string;\r\n                    \r\n                    if (typeof message.sender === 'string') {\r\n                      senderId = message.sender;\r\n                    } else if (message.sender && typeof message.sender === 'object') {\r\n                      // Check if it's a User object with _id\r\n                      if ('_id' in message.sender && message.sender._id) {\r\n                        // User object with _id\r\n                        if (typeof message.sender._id === 'string') {\r\n                          senderId = message.sender._id;\r\n                        } else {\r\n                          // Handle ObjectId object\r\n                          const json = JSON.parse(JSON.stringify(message.sender._id));\r\n                          senderId = typeof json === 'string' ? json : (json.$oid || json.toString());\r\n                        }\r\n                      } else {\r\n                        // It's an ObjectId - convert via JSON to get the actual ID string\r\n                        const jsonStr = JSON.stringify(message.sender);\r\n                        try {\r\n                          const parsed = JSON.parse(jsonStr);\r\n                          senderId = parsed.$oid || parsed.toString() || jsonStr.replace(/[{}\"]/g, '');\r\n                        } catch {\r\n                          senderId = jsonStr.replace(/[{}\"]/g, '');\r\n                        }\r\n                      }\r\n                    } else {\r\n                      senderId = '';\r\n                    }\r\n                    \r\n                    const senderUser =\r\n                      typeof message.sender === \"object\" && message.sender?.name\r\n                        ? message.sender  // Already populated User object\r\n                        : currentConversation?.participants.find(\r\n                            (p) => p._id === senderId\r\n                          );\r\n                    \r\n                    const isCurrentUser = senderId === user?._id;\r\n\r\n                    const getStringId = (id: any): string => {\r\n                      if (typeof id === 'string') return id;\r\n                      if (!id) return Math.random().toString();\r\n                      const json = JSON.parse(JSON.stringify(id));\r\n                      return typeof json === 'string' ? json : (json.$oid || json.toString());\r\n                    };\r\n\r\n                    return (\r\n                      <Box\r\n                        key={getStringId(message._id)}\r\n                        sx={{\r\n                          display: \"flex\",\r\n                          flexDirection: isCurrentUser ? \"row-reverse\" : \"row\",\r\n                          mb: 2,\r\n                        }}\r\n                      >\r\n                        {!isCurrentUser && senderUser && (\r\n                          <Avatar\r\n                            src={senderUser.avatar}\r\n                            alt={senderUser.name}\r\n                            sx={{ mr: 1, mt: 1 }}\r\n                          />\r\n                        )}\r\n\r\n                        <Box\r\n                          sx={{\r\n                            maxWidth: \"70%\",\r\n                            bgcolor: isCurrentUser\r\n                              ? \"primary.light\"\r\n                              : \"background.default\",\r\n                            color: isCurrentUser\r\n                              ? \"primary.contrastText\"\r\n                              : \"text.primary\",\r\n                            borderRadius: 2,\r\n                            p: 2,\r\n                            position: \"relative\",\r\n                          }}\r\n                        >\r\n                          {/* Message attachments */}\r\n                          {message.attachments &&\r\n                            message.attachments.length > 0 && (\r\n                              <Box sx={{ mb: message.content ? 1 : 0 }}>\r\n                                {message.attachments.map((attachment) =>\r\n                                  renderMessageAttachment(attachment)\r\n                                )}\r\n                              </Box>\r\n                            )}\r\n\r\n                          {/* Message content */}\r\n                          {message.content && (\r\n                            <Typography variant=\"body1\">\r\n                              {message.content}\r\n                            </Typography>\r\n                          )}\r\n\r\n                          {/* Message timestamp */}\r\n                          <Typography\r\n                            variant=\"caption\"\r\n                            sx={{\r\n                              display: \"block\",\r\n                              textAlign: \"right\",\r\n                              mt: 0.5,\r\n                              color: isCurrentUser\r\n                                ? \"rgba(255,255,255,0.7)\"\r\n                                : \"text.secondary\",\r\n                            }}\r\n                          >\r\n                            {formatMessageTime(message.createdAt)}\r\n                            {message.read && isCurrentUser && (\r\n                              <span style={{ marginLeft: \"4px\" }}>âœ“</span>\r\n                            )}\r\n                          </Typography>\r\n                        </Box>\r\n                      </Box>\r\n                    );\r\n                  })}\r\n                </Box>\r\n              )\r\n            )}\r\n            <div ref={messagesEndRef} />\r\n          </>\r\n        )}\r\n      </Paper>\r\n\r\n      {/* Message Input */}\r\n      <Paper elevation={2} sx={{ p: 2 }}>\r\n        {/* Attachment previews */}\r\n        {attachments.length > 0 && (\r\n          <Box sx={{ mb: 2, display: \"flex\", flexWrap: \"wrap\" }}>\r\n            {attachments.map((file, index) =>\r\n              renderAttachmentPreview(file, index)\r\n            )}\r\n          </Box>\r\n        )}\r\n\r\n        <Box sx={{ display: \"flex\", alignItems: \"center\" }}>\r\n          <IconButton onClick={() => fileInputRef.current?.click()}>\r\n            <AttachFileIcon />\r\n          </IconButton>\r\n          <input\r\n            type=\"file\"\r\n            ref={fileInputRef}\r\n            style={{ display: \"none\" }}\r\n            onChange={handleFileChange}\r\n            multiple\r\n          />\r\n\r\n          <TextField\r\n            fullWidth\r\n            placeholder=\"Type a message...\"\r\n            variant=\"outlined\"\r\n            value={messageText}\r\n            onChange={(e) => setMessageText(e.target.value)}\r\n            onKeyPress={(e) => {\r\n              if (e.key === \"Enter\" && !e.shiftKey) {\r\n                e.preventDefault();\r\n                handleSendMessage();\r\n              }\r\n            }}\r\n            multiline\r\n            maxRows={4}\r\n            sx={{ mx: 1 }}\r\n          />\r\n\r\n          <Button\r\n            variant=\"contained\"\r\n            color=\"primary\"\r\n            endIcon={<SendIcon />}\r\n            onClick={handleSendMessage}\r\n            disabled={\r\n              (!messageText.trim() && attachments.length === 0) || isSending\r\n            }\r\n          >\r\n            {isSending ? <CircularProgress size={24} /> : \"Send\"}\r\n          </Button>\r\n        </Box>\r\n      </Paper>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default Conversation;\r\n","import React, { useEffect } from \"react\";\r\nimport { useDispatch } from \"react-redux\";\r\nimport { Routes, Route, useLocation } from \"react-router-dom\";\r\nimport { socketService } from \"../../services/socketService\";\r\nimport { AppDispatch } from \"../../redux/store\";\r\n\r\n// Components\r\nimport ConversationList from \"./ConversationList\";\r\nimport Conversation from \"./Conversation\";\r\n\r\n// MUI components\r\nimport { Box } from \"@mui/material\";\r\nimport Grid from \"@mui/material/Grid\";\r\nimport Typography from \"@mui/material/Typography\";\r\nimport Hidden from \"@mui/material/Hidden\";\r\n\r\nconst Messages = () => {\r\n  const dispatch: AppDispatch = useDispatch();\r\n  const location = useLocation();\r\n\r\n  // Initialize socket connection when component mounts\r\n  useEffect(() => {\r\n    socketService.init(dispatch);\r\n\r\n    return () => {\r\n      socketService.disconnect();\r\n    };\r\n  }, [dispatch]);\r\n\r\n  // Check if we're on the main messages page or a specific conversation\r\n  const isConversationSelected = location.pathname !== \"/messages\";\r\n\r\n  return (\r\n    <Box sx={{ py: 3 }}>\r\n      <Typography variant=\"h4\" component=\"h1\" gutterBottom>\r\n        Messages\r\n      </Typography>\r\n\r\n      <Grid container spacing={3}>\r\n        {/* Conversation List - Always visible on desktop, hidden on mobile when viewing a conversation */}\r\n        <Hidden smDown={isConversationSelected}>\r\n          <Grid item xs={12} md={4}>\r\n            <ConversationList />\r\n          </Grid>\r\n        </Hidden>\r\n\r\n        {/* Conversation Detail - Full width on mobile, 8 columns on desktop */}\r\n        <Grid item xs={12} md={isConversationSelected ? 8 : 12}>\r\n          <Routes>\r\n            <Route\r\n              path=\"/\"\r\n              element={\r\n                <Hidden smUp>\r\n                  <ConversationList />\r\n                </Hidden>\r\n              }\r\n            />\r\n            <Route path=\"/:id\" element={<Conversation />} />\r\n          </Routes>\r\n        </Grid>\r\n      </Grid>\r\n    </Box>\r\n  );\r\n};\r\n\r\nexport default Messages;\r\n","import React, { useState, useEffect } from \"react\";\r\nimport { useSelector } from \"react-redux\";\r\nimport { useNavigate, useLocation } from \"react-router-dom\";\r\nimport { createConversation } from \"../../redux/slices/messageSlice\";\r\nimport { RootState, useAppDispatch } from \"../../redux/store\";\r\nimport axios from \"axios\";\r\n\r\n// MUI components\r\nimport Dialog from \"@mui/material/Dialog\";\r\nimport DialogTitle from \"@mui/material/DialogTitle\";\r\nimport DialogContent from \"@mui/material/DialogContent\";\r\nimport DialogActions from \"@mui/material/DialogActions\";\r\nimport TextField from \"@mui/material/TextField\";\r\nimport Button from \"@mui/material/Button\";\r\nimport Paper from \"@mui/material/Paper\";\r\nimport List from \"@mui/material/List\";\r\nimport ListItem from \"@mui/material/ListItem\";\r\nimport ListItemAvatar from \"@mui/material/ListItemAvatar\";\r\nimport ListItemText from \"@mui/material/ListItemText\";\r\nimport Avatar from \"@mui/material/Avatar\";\r\nimport Typography from \"@mui/material/Typography\";\r\nimport CircularProgress from \"@mui/material/CircularProgress\";\r\nimport InputAdornment from \"@mui/material/InputAdornment\";\r\nimport Chip from \"@mui/material/Chip\";\r\nimport Box from \"@mui/material/Box\";\r\n\r\n// MUI icons\r\nimport SearchIcon from \"@mui/icons-material/Search\";\r\nimport PersonIcon from \"@mui/icons-material/Person\";\r\nimport HomeIcon from \"@mui/icons-material/Home\";\r\n\r\n// Types\r\ninterface User {\r\n  _id: string;\r\n  name: string;\r\n  avatar?: string;\r\n  userType?: string;\r\n}\r\n\r\ninterface AuthState {\r\n  user: User | null;\r\n}\r\n\r\ninterface NewConversationProps {\r\n  open: boolean;\r\n  onClose: () => void;\r\n  propertyId?: string | null;\r\n  ownerId?: string | null;\r\n}\r\n\r\nconst NewConversation = ({\r\n  open,\r\n  onClose,\r\n  propertyId = null,\r\n  ownerId = null,\r\n}: NewConversationProps) => {\r\n  const dispatch = useAppDispatch();\r\n  const navigate = useNavigate();\r\n  const location = useLocation();\r\n\r\n  const { user } = useSelector((state: RootState) => state.auth as AuthState);\r\n\r\n  const [searchTerm, setSearchTerm] = useState<string>(\"\");\r\n  const [searchResults, setSearchResults] = useState<User[]>([]);\r\n  const [selectedUser, setSelectedUser] = useState<User | null>(null);\r\n  const [message, setMessage] = useState<string>(\"\");\r\n  const [loading, setLoading] = useState<boolean>(false);\r\n  const [searching, setSearching] = useState<boolean>(false);\r\n  const [error, setError] = useState<string>(\"\");\r\n\r\n  // Auto-fetch owner details when ownerId is provided\r\n  useEffect(() => {\r\n    const fetchOwnerDetails = async () => {\r\n      if (ownerId && !selectedUser && open) {\r\n        try {\r\n          setLoading(true);\r\n          const response = await axios.get(`/api/users/${ownerId}`);\r\n          const ownerData = response.data;\r\n          \r\n          // Auto-select the owner\r\n          setSelectedUser(ownerData);\r\n          \r\n          // Auto-generate a message if coming from a property\r\n          if (propertyId && !message) {\r\n            setMessage(\r\n              `Hi! I'm interested in your property. Could you tell me more about it?`\r\n            );\r\n          }\r\n        } catch (err) {\r\n          console.error(\"Error fetching owner details:\", err);\r\n          setError(\"Unable to load property owner information. Please search manually.\");\r\n        } finally {\r\n          setLoading(false);\r\n        }\r\n      }\r\n    };\r\n\r\n    fetchOwnerDetails();\r\n  }, [ownerId, selectedUser, open, propertyId, message]);\r\n\r\n  // Check if we're coming from a property page\r\n  useEffect(() => {\r\n    const queryParams = new URLSearchParams(location.search);\r\n    const propertyIdFromQuery = queryParams.get(\"propertyId\");\r\n    const ownerIdFromQuery = queryParams.get(\"ownerId\");\r\n\r\n    if (propertyIdFromQuery && !propertyId) {\r\n      // Handle property ID from query params if not provided as prop\r\n    }\r\n    if (ownerIdFromQuery && !ownerId) {\r\n      // Handle owner ID from query params if not provided as prop\r\n    }\r\n  }, [location.search, propertyId, ownerId]);\r\n\r\n  // Search users when search term changes\r\n  useEffect(() => {\r\n    const searchUsersDebounced = async () => {\r\n      if (searchTerm.trim().length < 2) {\r\n        setSearchResults([]);\r\n        return;\r\n      }\r\n\r\n      setSearching(true);\r\n      try {\r\n        const response = await axios.get(`/api/users`, {\r\n          params: { search: searchTerm }\r\n        });\r\n        // Filter out current user from search results\r\n        const filteredResults = response.data.users.filter(\r\n          (userResult: User) => userResult._id !== user?._id\r\n        );\r\n        setSearchResults(filteredResults);\r\n      } catch (err) {\r\n        console.error(\"Error searching users:\", err);\r\n        setSearchResults([]);\r\n      } finally {\r\n        setSearching(false);\r\n      }\r\n    };\r\n\r\n    const timeoutId = setTimeout(searchUsersDebounced, 300);\r\n    return () => clearTimeout(timeoutId);\r\n  }, [searchTerm, user]);\r\n\r\n  // Reset form when dialog closes\r\n  useEffect(() => {\r\n    if (!open) {\r\n      setSearchTerm(\"\");\r\n      setSearchResults([]);\r\n      setSelectedUser(null);\r\n      setMessage(\"\");\r\n      setError(\"\");\r\n    }\r\n  }, [open]);\r\n\r\n  // Handle user selection\r\n  const handleUserSelect = (user: User) => {\r\n    setSelectedUser(user);\r\n    setSearchTerm(\"\");\r\n    setSearchResults([]);\r\n\r\n    // Auto-generate a message if coming from a property\r\n    if (propertyId && !message) {\r\n      setMessage(\r\n        `Hi! I'm interested in your property. Could you tell me more about it?`\r\n      );\r\n    }\r\n  };\r\n\r\n  // Handle conversation creation\r\n  const handleCreateConversation = async () => {\r\n    if (!selectedUser) {\r\n      setError(\"Please select a user to message\");\r\n      return;\r\n    }\r\n\r\n    if (!message.trim()) {\r\n      setError(\"Please enter a message\");\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setError(\"\");\r\n\r\n    try {\r\n      const result = await dispatch(\r\n        createConversation({\r\n          recipient: selectedUser._id,\r\n          initialMessage: message.trim(),\r\n          property: propertyId || undefined,\r\n        }) as any\r\n      ).unwrap();\r\n\r\n      // Close dialog and navigate to the new conversation\r\n      onClose();\r\n      navigate(`/messages/${result._id}`);\r\n    } catch (err: any) {\r\n      console.error(\"Error creating conversation:\", err);\r\n      setError(err.message || \"Failed to create conversation\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Handle dialog close\r\n  const handleClose = () => {\r\n    onClose();\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onClose={handleClose} maxWidth=\"sm\" fullWidth>\r\n      <DialogTitle>\r\n        New Conversation\r\n        {propertyId && (\r\n          <Chip\r\n            icon={<HomeIcon />}\r\n            label=\"Property Related\"\r\n            size=\"small\"\r\n            color=\"primary\"\r\n            sx={{ ml: 1 }}\r\n          />\r\n        )}\r\n      </DialogTitle>\r\n\r\n      <DialogContent>\r\n        {!selectedUser ? (\r\n          // User selection phase\r\n          <Box>\r\n            <TextField\r\n              fullWidth\r\n              variant=\"outlined\"\r\n              placeholder=\"Search users by name...\"\r\n              value={searchTerm}\r\n              onChange={(e) => setSearchTerm(e.target.value)}\r\n              InputProps={{\r\n                startAdornment: (\r\n                  <InputAdornment position=\"start\">\r\n                    <SearchIcon />\r\n                  </InputAdornment>\r\n                ),\r\n              }}\r\n              sx={{ mb: 2 }}\r\n            />\r\n\r\n            {searching && (\r\n              <Box sx={{ display: \"flex\", justifyContent: \"center\", my: 2 }}>\r\n                <CircularProgress size={24} />\r\n              </Box>\r\n            )}\r\n\r\n            {searchResults.length > 0 && (\r\n              <Paper elevation={2} sx={{ maxHeight: 200, overflow: \"auto\" }}>\r\n                <List>\r\n                  {searchResults.map((user) => (\r\n                    <ListItem\r\n                      key={user._id}\r\n                      button\r\n                      onClick={() => handleUserSelect(user)}\r\n                    >\r\n                      <ListItemAvatar>\r\n                        <Avatar src={user.avatar} alt={user.name}>\r\n                          {!user.avatar && <PersonIcon />}\r\n                        </Avatar>\r\n                      </ListItemAvatar>\r\n                      <ListItemText\r\n                        primary={user.name}\r\n                        secondary={user.userType}\r\n                      />\r\n                    </ListItem>\r\n                  ))}\r\n                </List>\r\n              </Paper>\r\n            )}\r\n\r\n            {searchTerm.length >= 2 &&\r\n              searchResults.length === 0 &&\r\n              !searching && (\r\n                <Typography\r\n                  variant=\"body2\"\r\n                  color=\"text.secondary\"\r\n                  sx={{ textAlign: \"center\", my: 2 }}\r\n                >\r\n                  No users found\r\n                </Typography>\r\n              )}\r\n          </Box>\r\n        ) : (\r\n          // Message composition phase\r\n          <Box>\r\n            <Box\r\n              sx={{\r\n                display: \"flex\",\r\n                alignItems: \"center\",\r\n                mb: 2,\r\n                p: 1,\r\n                bgcolor: \"grey.100\",\r\n                borderRadius: 1,\r\n              }}\r\n            >\r\n              <Avatar\r\n                src={selectedUser.avatar}\r\n                alt={selectedUser.name}\r\n                sx={{ mr: 2 }}\r\n              >\r\n                {!selectedUser.avatar && <PersonIcon />}\r\n              </Avatar>\r\n              <Box>\r\n                <Typography variant=\"subtitle1\">{selectedUser.name}</Typography>\r\n                <Typography variant=\"body2\" color=\"text.secondary\">\r\n                  {selectedUser.userType}\r\n                </Typography>\r\n              </Box>\r\n              <Button\r\n                size=\"small\"\r\n                onClick={() => setSelectedUser(null)}\r\n                sx={{ ml: \"auto\" }}\r\n              >\r\n                Change\r\n              </Button>\r\n            </Box>\r\n\r\n            <TextField\r\n              fullWidth\r\n              multiline\r\n              rows={4}\r\n              variant=\"outlined\"\r\n              placeholder=\"Type your message here...\"\r\n              value={message}\r\n              onChange={(e) => setMessage(e.target.value)}\r\n              sx={{ mb: 2 }}\r\n            />\r\n\r\n            {propertyId && (\r\n              <Typography variant=\"caption\" color=\"text.secondary\">\r\n                This conversation is related to a property listing\r\n              </Typography>\r\n            )}\r\n          </Box>\r\n        )}\r\n\r\n        {error && (\r\n          <Typography color=\"error\" variant=\"body2\" sx={{ mt: 1 }}>\r\n            {error}\r\n          </Typography>\r\n        )}\r\n      </DialogContent>\r\n\r\n      <DialogActions>\r\n        <Button onClick={handleClose}>Cancel</Button>\r\n        <Button\r\n          onClick={handleCreateConversation}\r\n          variant=\"contained\"\r\n          disabled={!selectedUser || !message.trim() || loading}\r\n        >\r\n          {loading ? <CircularProgress size={24} /> : \"Start Conversation\"}\r\n        </Button>\r\n      </DialogActions>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default NewConversation;\r\n"],"names":["socket","socketService","dispatch","token","localStorage","getItem","initSocket","close","io","auth","transports","on","console","log","error","showAlert","data","receiveMessage","message","conversationId","markConversationAsRead","updateTotalUnreadCount","count","closeSocket","emit","emitTyping","isTyping","ConversationList","useAppDispatch","navigate","useNavigate","location","useLocation","user","useSelector","state","conversations","loading","searchTerm","setSearchTerm","useState","menuAnchorEl","setMenuAnchorEl","selectedConversation","setSelectedConversation","newConversationOpen","setNewConversationOpen","useEffect","getConversations","handleMenuClose","formatLastMessageTime","timestamp","date","Date","diffMs","getTime","diffMins","Math","floor","diffHours","diffDays","concat","toLocaleDateString","month","day","getOtherParticipant","conversation","participants","find","participant","_id","filteredConversations","filter","otherParticipant","name","toLowerCase","includes","renderConversationItem","isActive","pathname","lastMessage","_jsxs","React","children","ListItem","button","alignItems","onClick","handleConversationClick","sx","bgcolor","py","_jsx","ListItemAvatar","Badge","color","badgeContent","unreadCount","invisible","overlap","Avatar","alt","src","avatar","ListItemText","primary","Box","display","justifyContent","Typography","variant","fontWeight","createdAt","secondary","noWrap","attachments","length","component","content","property","Chip","icon","HomeIcon","fontSize","label","title","substring","size","mt","maxWidth","ListItemSecondaryAction","IconButton","edge","e","handleMenuOpen","event","stopPropagation","currentTarget","MoreVertIcon","Divider","height","flexDirection","mb","gap","Paper","p","boxShadow","flexGrow","SearchIcon","InputBase","ml","flex","placeholder","value","onChange","target","Button","startIcon","AddIcon","elevation","overflow","maxHeight","List","Array","map","_","index","Skeleton","width","align","Menu","anchorEl","open","Boolean","onClose","MenuItem","handleArchiveConversation","archiveConversation","ArchiveIcon","mr","DeleteIcon","NewConversation","Conversation","_currentConversation$","id","useParams","useDispatch","currentConversation","messages","messageText","setMessageText","setAttachments","setIsTyping","typingTimeout","setTypingTimeout","isSending","setIsSending","messagesEndRef","useRef","fileInputRef","getMessages","scrollToBottom","clearTimeout","timeout","setTimeout","_messagesEndRef$curre","current","scrollIntoView","behavior","handleSendMessage","async","trim","sendMessage","formatMessageTime","today","yesterday","setDate","getDate","toDateString","toLocaleTimeString","hour","minute","formatDateHeader","dateString","weekday","renderAttachmentPreview","file","isImage","type","startsWith","position","m","borderRadius","border","borderColor","URL","createObjectURL","objectFit","InsertDriveFileIcon","top","right","i","handleRemoveAttachment","bottom","left","textOverflow","whiteSpace","px","CircularProgress","ArrowBackIcon","_Fragment","userType","split","word","charAt","toUpperCase","slice","join","renderPropertyCard","Card","CardMedia","image","images","CardContent","address","city","price","amount","brokerage","Object","entries","groupMessagesByDate","groups","forEach","push","_ref","dateMessages","my","_message$sender","senderId","sender","json","JSON","parse","stringify","$oid","toString","jsonStr","parsed","replace","_unused","senderUser","isCurrentUser","attachment","mimetype","url","String","href","rel","textDecoration","filename","renderMessageAttachment","textAlign","read","style","marginLeft","random","getStringId","ref","flexWrap","_fileInputRef$current","click","AttachFileIcon","files","from","validFiles","isValidSize","alert","multiple","TextField","fullWidth","onKeyPress","key","shiftKey","preventDefault","multiline","maxRows","mx","endIcon","SendIcon","disabled","Messages","isConversationSelected","gutterBottom","Grid","container","spacing","Hidden","smDown","item","xs","md","Routes","Route","path","element","smUp","propertyId","ownerId","searchResults","setSearchResults","selectedUser","setSelectedUser","setMessage","setLoading","searching","setSearching","setError","ownerData","axios","get","err","fetchOwnerDetails","queryParams","URLSearchParams","search","timeoutId","filteredResults","params","users","userResult","handleClose","Dialog","DialogTitle","DialogContent","PersonIcon","rows","InputProps","startAdornment","InputAdornment","handleUserSelect","DialogActions","result","createConversation","recipient","initialMessage","undefined","unwrap"],"sourceRoot":""}